generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "commonjs"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ==================== USER ====================

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  avatar          String?
  role            UserRole @default(USER)
  isActive        Boolean  @default(true)
  canRefreshToken Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  vocabularyProgress UserVocabularyProgress[]
  userTopics         UserTopicProgress[]

  @@map("users")
}

// ==================== TOPIC ====================

model Topic {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  thumbnail   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vocabularies Vocabulary[]
  userProgress UserTopicProgress[]

  @@map("topics")
}

// ==================== VOCABULARY ====================

model Vocabulary {
  id            String   @id @default(cuid())
  word          String // Từ tiếng Anh
  pronunciation String? // Phiên âm IPA
  audioUrl      String? // URL file âm thanh phát âm
  meaning       String // Nghĩa tiếng Việt
  partOfSpeech  String? // Loại từ (noun, verb, adj...)
  exampleEn     String? // Ví dụ tiếng Anh
  exampleVi     String? // Dịch ví dụ
  imageUrl      String? // Hình ảnh minh họa
  synonyms      String[] // Từ đồng nghĩa
  antonyms      String[] // Từ trái nghĩa
  topicId       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  topic        Topic                    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  userProgress UserVocabularyProgress[]

  @@unique([word, topicId])
  @@index([topicId])
  @@map("vocabularies")
}

// ==================== USER VOCABULARY PROGRESS ====================

model UserVocabularyProgress {
  id           String @id @default(cuid())
  userId       String
  vocabularyId String

  lastReviewedAt DateTime?
  halfLife       Float     @default(1.0) // Thời gian để retention = 50% (ngày)
  nextReviewAt   DateTime? // Cache để query hiệu quả

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabulary Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabularyId])
  @@index([userId])
  @@index([vocabularyId])
  @@index([userId, nextReviewAt])
  @@map("user_vocabulary_progress")
}

// ==================== USER TOPIC PROGRESS ====================

model UserTopicProgress {
  id      String @id @default(cuid())
  userId  String
  topicId String

  learningWords Int @default(0)
  learnedWords  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
  @@map("user_topic_progress")
}
